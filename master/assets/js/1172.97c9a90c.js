(window.webpackJsonp=window.webpackJsonp||[]).push([[1172],{2515:function(t,s,e){"use strict";e.r(s);var a=e(18),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"手动生成客户端和代理端代码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#手动生成客户端和代理端代码"}},[t._v("#")]),t._v(" 手动生成客户端和代理端代码")]),t._v(" "),e("p",[t._v("本主题演示如何手动生成客户端和代理的代码（而不是编译 PX4 时"),e("RouterLink",{attrs:{to:"/zh/middleware/micrortps.html"}},[t._v("自动生成")]),t._v("的）。")],1),t._v(" "),e("p",[t._v("代码是使用 python 脚本生成的："),e("strong",[t._v("/Tools/generate_microRTPS_bridge.py")]),t._v("。")]),t._v(" "),e("h2",{attrs:{id:"禁用自动桥接代码生成"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#禁用自动桥接代码生成"}},[t._v("#")]),t._v(" 禁用自动桥接代码生成")]),t._v(" "),e("p",[t._v("首先禁用桥接代码的自动生成。 First disable automatic generation of bridge code. Set the variable "),e("code",[t._v("GENERATE_RTPS_BRIDGE")]),t._v(" to "),e("em",[t._v("off")]),t._v(" in the "),e("strong",[t._v(".cmake")]),t._v(" file for the target platform:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("set"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GENERATE_RTPS_BRIDGE off"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("h2",{attrs:{id:"使用-generate-micrortps-bridge-py"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-generate-micrortps-bridge-py"}},[t._v("#")]),t._v(" 使用 generate_microRTPS_bridge. py")]),t._v(" "),e("p",[e("em",[t._v("generate_microRTPS_bridge")]),t._v(" 工具的命令语法如下所示:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /path/to/PX4/Firmware/msg/tools\n$ python generate_microRTPS_bridge.py -h\nusage: generate_microRTPS_bridge.py "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-h"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-s *.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("*.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n                                    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-r *.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("*.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-a"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n                                    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-t MSGDIR"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-o AGENTDIR"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-u CLIENTDIR"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n                                    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-f FASTRTPSGEN"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\noptional arguments:\n  -h, --help            显示这个帮助信息并退出\n  -s *.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("*.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", --send *.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("*.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n                        要发送的 Topic\n  -r *.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("*.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", --receive *.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("*.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n                        要接收的 Topic\n  -a, --agent           生成 agent 的参数。\n                                    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-r *.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("*.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-a"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n                                    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-t MSGDIR"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-o AGENTDIR"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-u CLIENTDIR"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n                                    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-f FASTRTPSGEN"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\noptional arguments:\n  -h, --help            show this "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("help")]),t._v(" message and "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v("\n  -s *.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("*.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", --send *.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("*.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n                        Topics to be sent\n  -r *.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("*.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", --receive *.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("*.msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n                        Topics to be received\n  -a, --agent           Flag to generate the agent. 默认值为 true。\n  -c, --client          Flag to generate the client. 默认值为 true。 默认值为 true。\n  -t MSGDIR, --topic-msg-dir MSGDIR\n                        主题消息目录。 -t MSGDIR, --topic-msg-dir MSGDIR\n                        Topics message dir. 默认为： msg/\n  -o AGENTDIR, --agent-outdir AGENTDIR\n                        Agent 输出目录。 Src/modules/micrortps_bridge/micrortps_agent\n  -u CLIENTDIR, --client-outdir CLIENTDIR\n                        客户端输出目录。 Default is:\n                        src/modules/micrortps_bridge/micrortps_agent\n  -u CLIENTDIR, --client-outdir CLIENTDIR\n                        Client output dir. Default is:\n                        src/modules/micrortps_bridge/micrortps_client\n  -f FASTRTPSGEN, --fastrtpsgen-dir FASTRTPSGEN\n                        fastrtpsgen installation dir. Default is: /bin\n  --delete-tree         Delete "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("dir")]),t._v(" tree output dir"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" 默认是： /bin\n  --delete-tree         删除目录树\n")])])]),e("blockquote",[e("p",[e("strong",[t._v("Caution")]),t._v(" 在创建新文件和文件夹之前，使用 "),e("code",[t._v("--delete-tree")]),t._v(" 选项会删除 "),e("code",[t._v("CLIENTDIR")]),t._v(" 和 "),e("code",[t._v("AGENTDIR")]),t._v(" 的内容。")])]),t._v(" "),e("ul",[e("li",[t._v("The arguments "),e("code",[t._v("--send/-s")]),t._v(" and "),e("code",[t._v("--receive/-r")]),t._v(" specify the uORB topics that can be sent/received from PX4. Code will only be generated for specified messages. 将仅为指定的消息生成代码。")]),t._v(" "),e("li",[t._v("输出显示在 "),e("code",[t._v("CLIENTDIR")]),t._v(" (默认情况下 "),e("code",[t._v("src/modules/micrortps_bridge/micrortps_client</0 >) 和 <code>AGENTDIR")]),t._v(" (默认情况下 "),e("code",[t._v("-u src/modules/micrortps_bridge/micrortps_agent</0 >) 中。</li> <li>如果未指定标志 <code>-a")]),t._v(" 或 "),e("code",[t._v("-c")]),t._v("，则将生成并安装客户端和代理。")]),t._v(" "),e("li",[t._v("如果未在默认位置（"),e("code",[t._v("-f /path/to/fastrtps/installation/bin")]),t._v("）安装 "),e("em",[t._v("Fast rtps")]),t._v("，则可能需要 "),e("code",[t._v("-f")]),t._v(" 选项。")])]),t._v(" "),e("p",[t._v("下面的示例演示如何生成桥接代码以发布/订阅 "),e("code",[t._v("sensor_baro")]),t._v(" 单个 uORB 主题。")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /path/to/PX4/Firmware\n$ python Tools/generate_microRTPS_bridge.py -s msg/sensor_baro.msg -r msg/sensor_combined.msg\n")])])]),e("h2",{attrs:{id:"生成代码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#生成代码"}},[t._v("#")]),t._v(" 生成代码")]),t._v(" "),e("p",[t._v("为 "),e("em",[t._v("Client")]),t._v("、"),e("em",[t._v("Agent")]),t._v("、"),e("em",[t._v("CDR serialization/deserialization")]),t._v(" 的 uORB 消息以及关联的 RTPS 报文 (IDL 文件) 的定义生成代码。")]),t._v(" "),e("p",[t._v("可以在此处找到网桥的手动生成的代码（默认情况下）：")]),t._v(" "),e("ul",[e("li",[e("em",[t._v("客户端")]),t._v(": "),e("strong",[t._v("src/modules/micrortps_bridge/micrortps_client/")])]),t._v(" "),e("li",[e("em",[t._v("代理端")]),t._v(": "),e("strong",[t._v("src/modules/micrortps_bridge/micrortps_agent/")])])]),t._v(" "),e("h3",{attrs:{id:"uorb-序列化代码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#uorb-序列化代码"}},[t._v("#")]),t._v(" uORB 序列化代码")]),t._v(" "),e("p",[t._v("Serialization functions are generated for all the uORB topics as part of the normal PX4 compilation process (and also for manual generation). For example, the following functions would be generated for the "),e("em",[t._v("sensor_combined.msg")]),t._v(": 例如，将为 "),e("em",[t._v("sensor_combined.msg")]),t._v(" 生成以下函数：")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("void serialize_sensor_combined"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("const struct sensor_combined_s *input, char *output, uint32_t *length, struct microCDR *microCDRWriter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nvoid deserialize_sensor_combined"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("struct sensor_combined_s *output, char *input, struct microCDR *microCDRReader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h3",{attrs:{id:"rtps-报文-idl-文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#rtps-报文-idl-文件"}},[t._v("#")]),t._v(" RTPS 报文 IDL 文件")]),t._v(" "),e("p",[t._v("IDL files are generated from the uORB "),e("strong",[t._v(".msg")]),t._v(" files ("),e("RouterLink",{attrs:{to:"/zh/middleware/micrortps.html#supported-uorb-messages"}},[t._v("for selected uORB topics")]),t._v(") in the generation of the bridge. These can be found in: "),e("strong",[t._v("src/modules/micrortps_bridge/micrortps_agent/idl/")]),t._v(" 这些可以在 "),e("strong",[t._v("src/modules/micrortps_bridge/micrortps_agent/idl/")]),t._v(" 中找到。")],1),t._v(" "),e("p",[e("em",[t._v("FastRTSP")]),t._v(" 使用 IDL 文件来定义 RTPS 消息的结构（在本例中，映射到 uORB 主题的 RTPS 消息）。 "),e("em",[t._v("FastRTSP")]),t._v(" uses IDL files to define the structure of RTPS messages (in this case, RTPS messages that map to uORB topics). They are used to generate code for the "),e("em",[t._v("Agent")]),t._v(", and "),e("em",[t._v("FastRTSP")]),t._v(" applications that need to publish/subscribe to uORB topics.")]),t._v(" "),e("blockquote",[e("p",[e("strong",[t._v("Note")]),t._v(" IDL 文件由 "),e("em",[t._v("fastrtpsgen")]),t._v(" 工具编译到 c++。")])]),t._v(" "),e("h2",{attrs:{id:"代码生成验证"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#代码生成验证"}},[t._v("#")]),t._v(" 代码生成验证")]),t._v(" "),e("p",[t._v("可以通过检查输出目录是否与下面显示的列表匹配来验证成功的代码生成（在 Linux 上，"),e("code",[t._v("tree")]),t._v(" 命令可用于列出文件结构）。")]),t._v(" "),e("p",[t._v("代理目录:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("$ tree src/modules/micrortps_bridge/micrortps_agent\nsrc/modules/micrortps_bridge/micrortps_agent\n├── build\n├── CMakeLists.txt\n├── idl\n│   ├── sensor_baro_.idl\n│   └── sensor_combined_.idl\n├── microRTPS_agent.cpp\n├── microRTPS_transport.cpp\n├── microRTPS_transport.h\n├── RtpsTopics.cpp\n├── RtpsTopics.h\n├── sensor_baro_.cpp\n├── sensor_baro_.h\n├── sensor_baro_Publisher.cpp\n├── sensor_baro_Publisher.h\n├── sensor_baro_PubSubTypes.cpp\n├── sensor_baro_PubSubTypes.h\n├── sensor_combined_.cpp\n├── sensor_combined_.h\n├── sensor_combined_PubSubTypes.cpp\n├── sensor_combined_PubSubTypes.h\n├── sensor_combined_Subscriber.cpp\n└── sensor_combined_Subscriber.h\n "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" directories, "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v(" files\n")])])]),e("p",[t._v("客户端目录：")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("$ tree src/modules/micrortps_bridge/micrortps_client\nsrc/modules/micrortps_bridge/micrortps_client\n├── CMakeLists.txt\n├── microRTPS_client.cpp\n├── microRTPS_client_dummy.cpp\n├── microRTPS_client_main.cpp\n├── microRTPS_transport.cpp\n└── microRTPS_transport.h\n "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" directories, "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" files\n")])])]),e("h2",{attrs:{id:"构建并使用代码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#构建并使用代码"}},[t._v("#")]),t._v(" 构建并使用代码")]),t._v(" "),e("p",[t._v("The manually generated "),e("em",[t._v("Client")]),t._v(" code is built and used in "),e("em",[t._v("exactly")]),t._v(" the same way as "),e("RouterLink",{attrs:{to:"/zh/middleware/micrortps.html#client-px4-firmware"}},[t._v("automatically generated Client code")]),t._v(".")],1),t._v(" "),e("p",[t._v("Specifically, once manually generated, the "),e("em",[t._v("Client")]),t._v(" source code is compiled and built into the PX4 firmware as part of the normal build process. For example, to compile the code and include it in firmware for NuttX/Pixhawk targets: 例如，编译代码，将其加入 NuttX/Pixhawk 固件：")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" px4_fmu-v4_default upload\n")])])]),e("blockquote",[e("p",[e("strong",[t._v("Note")]),t._v(" You must first "),e("a",{attrs:{href:"#disable-automatic-bridge-code-generation"}},[t._v("disable automatic bridge code generation")]),t._v(" so that the toolchain uses the manually generated source code (and does not attempt to regenerate it).")])]),t._v(" "),e("p",[t._v("The manually generated "),e("em",[t._v("Agent")]),t._v(" code is also compiled and used in the same way as the "),e("RouterLink",{attrs:{to:"/zh/middleware/micrortps.html#agent-off-board-fastrtps-interface"}},[t._v("automatically generated code")]),t._v(". The only difference is that the manually source code is created in "),e("strong",[t._v("src/modules/micrortps_bridge/micrortps_agent")]),t._v(" instead of "),e("strong",[e("emphasis",[t._v("build/BUILDPLATFORM")]),t._v("****/src/modules/micrortps_bridge/micrortps_agent/")],1),t._v(". The only difference is that the manually source code is created in "),e("strong",[t._v("src/modules/micrortps_bridge/micrortps_agent")]),t._v(" instead of "),e("strong",[e("emphasis",[t._v("build/BUILDPLATFORM")])],1),e("strong",[t._v("/src/modules/micrortps_bridge/micrortps_agent/")]),t._v(".")],1)])}),[],!1,null,null,null);s.default=n.exports}}]);